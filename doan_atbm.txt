CONN SYS AS SYSDBA;
alter session set "_ORACLE_SCRIPT"=true; 

DROP USER admin;
CREATE USER admin IDENTIFIED BY admin123;
GRANT CREATE SESSION TO admin;
GRANT DBA TO admin;

CONN admin/admin123;
alter session set "_ORACLE_SCRIPT"=true; 

/
declare
   c int;
begin
   select count(*) into c from user_tables where table_name = upper('KETQUA');
   if c = 1 then
      execute immediate 'drop table KETQUA';
   end if;
end;
/
declare
   c int;
begin
   select count(*) into c from user_tables where table_name = upper('UNGCUVIEN');
   if c = 1 then
      execute immediate 'drop table UNGCUVIEN';
   end if;
end;
/
declare
   c int;
begin
   select count(*) into c from user_tables where table_name = upper('THANHVIEN');
   if c = 1 then
      execute immediate 'drop table THANHVIEN';
   end if;
end; 
/
declare
   c int;
begin
   select count(*) into c from user_tables where table_name = upper('DONVI');
   if c = 1 then
      execute immediate 'drop table DONVI';
   end if;
end; 
/

--drop table ketqua;
CREATE TABLE KETQUA 
(
    MANGUOIBAU INT, 
    MAUCV INT, 
    NGAYBB DATE,
    CONSTRAINT KETQUA_PK PRIMARY KEY (MANGUOIBAU, MAUCV, NGAYBB)
); 
/
--drop table ungcuvien;
CREATE TABLE UNGCUVIEN 
(
    MATV INT, 
    SOPHIEUBAU INT,
    CONSTRAINT UNGCUVIEN_PK PRIMARY KEY (MATV)
);
/
--drop table thanhvien;
CREATE TABLE THANHVIEN
(
    MATV INT,
    HOTEN NVARCHAR2(100),
    PHAI INT,
    QUEQUAN NVARCHAR2(50),
    NGAYSINH DATE,
    QUOCTICH NVARCHAR2(50),
    DIACHITHUONGTRU NVARCHAR2(50),
    DIACHITAMTRU NVARCHAR2(50),
    COMAT INT,
    MADV INT,
    TENDANGNHAP VARCHAR(50) DEFAULT NULL,
    NHIEMVU VARCHAR(50) DEFAULT NULL,
    COQUYENDIBAU INT DEFAULT 0,
    CONSTRAINT THANHVIEN_PK PRIMARY KEY(MATV)
);
/

CREATE TABLE DONVI
(
MADV INT, 
TENDV NVARCHAR2 (50),
CONSTRAINT DONVI_PK PRIMARY KEY (MADV)
);
/

-- FOREIGN KEY
ALTER TABLE KETQUA ADD CONSTRAINT FK_KETQUA_THANHVIEN
FOREIGN KEY (MANGUOIBAU) REFERENCES THANHVIEN(MATV);
ALTER TABLE KETQUA ADD CONSTRAINT FK_KETQUA_UNGCUVIEN 
FOREIGN KEY (MAUCV) REFERENCES UNGCUVIEN(MATV);

ALTER TABLE UNGCUVIEN ADD CONSTRAINT FK_UNGCUVIEN_THANHVIEN
FOREIGN KEY (MATV) REFERENCES THANHVIEN (MATV);

ALTER TABLE THANHVIEN ADD CONSTRAINT FK_THANHVIEN_DONVI
FOREIGN KEY (MADV) REFERENCES DONVI (MADV);


-----------------------DON VI---------------------
INSERT INTO DONVI (MADV, TENDV) VALUES (1, 'DON VI 1');
INSERT INTO DONVI (MADV, TENDV) VALUES (2, 'DON VI 2');
INSERT INTO DONVI (MADV, TENDV) VALUES (3, 'DON VI 3');
INSERT INTO DONVI (MADV, TENDV) VALUES (4, 'DON VI 4');

-----------------------THANH VIEN---------------------
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(1, 'NGUYEN VAN NAM', 1, 'QUANG BINH', TO_DATE('12/5/1989','MM-DD-YYYY'), 'VIETNAM', '217 TAY SON', '21 PHAM VAN DONG', 1, 2, 'nhanvien1',1);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(2, 'BUI THI XUAN', 0, 'QUANG NGAI', TO_DATE('11/8/1999','MM-DD-YYYY'), 'VIETNAM', '26 NGUYEN BINH', '1 PHAN BOI CHAU', 1, 3, 'nhanvien2','NGUOIDIBAU',1);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(3, 'PHAM VAN BANH', 1, 'BUON MA THUOT', TO_DATE('12/12/1987','MM-DD-YYYY'), 'VIETNAM', '1 LE LOI', '877 LE LAI', 0, 4, 'nhanvien3',NULL,0);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(4, 'NGUYEN THI BE', 0, 'DA LAT', TO_DATE('12/9/1977','MM-DD-YYYY'), 'VIETNAM', '13 YASIN', '766 Y JUT', 1, 1, 'nhanvien4','TOTHEODOIKETQUA',1);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU,COQUYENDIBAU)
VALUES(5, 'JUNE NGUYEN', 1, 'NEW YORK', TO_DATE('10/5/1989','MM-DD-YYYY'), 'MY', '255 ST.JONH', '255 ST.JONH', 1, 1, 'nhanvien5',NULL,0);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(6, 'PHAM HAN', 0, 'HA NOI', TO_DATE('1/8/1979','MM-DD-YYYY'), 'VIETNAM', '21 TAY HO', '90 NGUYEN THI DINH', 0, 2, 'nhanvien6',NULL,0);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(7, 'LE VAN NAM', 1, 'HA TINH', TO_DATE('12/10/1987','MM-DD-YYYY'), 'VIETNAM', '18 NGUYEN BINH KHIEM', '18 NGUYEN BINH KHIEM', 1, 3, 'nhanvien7','NGUOIDIBAU',1);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(8, 'PHAN THI HIEN', 0, 'QUANG NAM', TO_DATE('10/12/1989','MM-DD-YYYY'), 'VIETNAM', '217 LE LOI', '217 LE LOI', 1, 2, 'nhanvien8',NULL,1);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(9, 'HO THI MAI', 0, 'LAO CAI', TO_DATE('10/5/1978','MM-DD-YYYY'), 'VIETNAM', '17 NGUYEN TIEU LA', '17 NGUYEN TIEU LA', 1, 1, 'nhanvien9','NGUOIDIBAU',1);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(10, 'NGUYEN VAN HO', 1, 'HO CHI MINH', TO_DATE('12/5/1999','MM-DD-YYYY'), 'VIETNAM', '8 HOA HAO', '8 HOA HAO', 1, 4, 'nhanvien10',NULL,1);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(11, 'HO THI NI', 0, 'GIA LAI', TO_DATE('2/11/1979','MM-DD-YYYY'), 'VIETNAM', '45 DAO DUY TU', '45 DAO DUY TU', 0, 4, 'nhanvien11',NULL,0);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(12, 'DO VAN BANH', 1, 'BINH DINH', TO_DATE('12/9/1986','MM-DD-YYYY'), 'VIETNAM', '217 TAY SON', '217 TAY SON', 1, 3, 'nhanvien12',NULL,0);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(13, 'NGUYEN BINH', 1, 'DA NANG', TO_DATE('12/5/1979','MM-DD-YYYY'), 'VIETNAM', '27 ONG BICH KHIEM', '27 ONG BICH KHIEM', 1, 1, 'nhanvien13',NULL,1);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(14, 'BUI VAN HU', 1, 'HOI AN', TO_DATE('12/10/1979','MM-DD-YYYY'), 'VIETNAM', '5 LE HONG PHONG', '5 LE HONG PHONG', 1, 3, 'nhanvien14',NULL,0);
INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(15, 'DO HIEN', 0, 'VINH LONG', TO_DATE('1/5/1989','MM-DD-YYYY'), 'VIETNAM', '7 HUYNH VAN BANH', '7 HUYNH VAN BANH', 1, 4, 'nhanvien15',NULL,0);

INSERT INTO THANHVIEN (MATV,HOTEN, PHAI, QUEQUAN, NGAYSINH, QUOCTICH, DIACHITHUONGTRU, DIACHITAMTRU, COMAT, MADV, TENDANGNHAP, NHIEMVU, COQUYENDIBAU)
VALUES(25, 'DO tiu thIEN', 0, 'VINH LONG', TO_DATE('1/5/1989','MM-DD-YYYY'), 'VIETNAM', '7 HUYNH VAN BANH', '7 HUYNH VAN BANH', 1, 4, 'admin',NULL,0);
 

--------------------------------UNG CU VIEN------------------------------
INSERT INTO UNGCUVIEN (MATV, SOPHIEUBAU) VALUES (5, 2);
INSERT INTO UNGCUVIEN (MATV, SOPHIEUBAU) VALUES (8, 3);
INSERT INTO UNGCUVIEN (MATV, SOPHIEUBAU) VALUES (10, 4);
INSERT INTO UNGCUVIEN (MATV, SOPHIEUBAU) VALUES (13, 2);
INSERT INTO UNGCUVIEN (MATV, SOPHIEUBAU) VALUES (15, 0);

------------------------------KET QUA-------------------------------------
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (1, 8, TO_DATE('10/6/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (1, 5, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (1, 10, TO_DATE('10/7/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (2, 5, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (2, 13, TO_DATE('10/9/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (2, 15, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (4, 5, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (4, 10, TO_DATE('10/6/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (4, 13, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (7, 5, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (7, 8, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (7, 10, TO_DATE('10/7/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (9, 5, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (9, 8, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (9, 15, TO_DATE('10/6/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (12, 8, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (12, 10, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (12, 15, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (14, 8, TO_DATE('10/7/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (14, 10, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA (MANGUOIBAU, MAUCV, NGAYBB) VALUES (14, 13, TO_DATE('10/5/2020','MM-DD-YYYY'));

/*
alter session set "_oracle_script"=true;
DROP ROLE BANTOCHUCBINHBAU;
DROP ROLE NGUOIDIBAU;
DROP ROLE TOLAPDANHSACH;
DROP ROLE TOTHEODOIKETQUA;
DROP ROLE TOGIAMSAT;*/

alter session set "_oracle_script"=true
CREATE ROLE BANTOCHUCBINHBAU;
CREATE ROLE NGUOIDIBAU;
CREATE ROLE TOLAPDANHSACH;
CREATE ROLE TOTHEODOIKETQUA;
CREATE ROLE TOGIAMSAT;



--DROP USER nhanvien1;
CREATE USER nhanvien1 IDENTIFIED BY abc123;
GRANT CREATE SESSION TO nhanvien1;
GRANT BANTOCHUCBINHBAU TO nhanvien1;

--DROP USER nhanvien2;
CREATE USER nhanvien2 IDENTIFIED BY abc123;
GRANT CREATE SESSION TO nhanvien2;
GRANT NGUOIDIBAU TO nhanvien2;

--DROP USER nhanvien3;
CREATE USER nhanvien3 IDENTIFIED BY abc123;
GRANT CREATE SESSION TO nhanvien3;
GRANT TOLAPDANHSACH TO nhanvien3;



--DROP USER nhanvien4;
CREATE USER nhanvien4 IDENTIFIED BY abc123;
GRANT CREATE SESSION TO nhanvien4;
GRANT TOTHEODOIKETQUA TO nhanvien4;

--DROP USER nhanvien5;
CREATE USER nhanvien5 IDENTIFIED BY abc123;
GRANT CREATE SESSION TO nhanvien5;
GRANT TOGIAMSAT TO nhanvien5;

SELECT* FROM THANHVIEN;

--TC3
   

CREATE OR REPLACE VIEW VIEW_TC3_1 AS SELECT MATV,HOTEN FROM THANHVIEN WHERE COQUYENDIBAU = 1;

--dangnhap bang sys vi bang dual chi co sys ms truy cap dc

CREATE OR REPLACE VIEW VIEW_TC3_3 AS SELECT a.HOTEN, b.* 
FROM THANHVIEN a,(SELECT MAUCV, COUNT(MAUCV) AS SOLUONGPHIEUBAU FROM KETQUA GROUP BY MAUCV) b WHERE a.MATV = b.MAUCV;

GRANT SELECT ON VIEW_TC3_1 TO TOTHEODOIKETQUA;
GRANT SELECT ON VIEW_TC3_2 TO TOTHEODOIKETQUA;
GRANT SELECT ON VIEW_TC3_3 TO TOTHEODOIKETQUA;


GRANT SELECT ON VIEW_TC3_2 TO TOLAPDANHSACH;
grant tolapdanhsach to nhanvien7;
 
--grant select on dual to admin with grant option; 
create view xem_madv as select madv from admin.thanhvien where tendangnhap=lower(user);
grant select on xem_madv to tolapdanhsach; 
CREATE OR REPLACE VIEW VIEW_TC3_2 AS SELECT DISTINCT K.MANGUOIBAU, T.HOTEN,T.PHAI,T.QUEQUAN,T.NGAYSINH,T.QUOCTICH,T.DIACHITHUONGTRU, T.madv
FROM KETQUA K, UNGCUVIEN U, THANHVIEN T
WHERE K.MANGUOIBAU = T.MATV
and T.madv in (select * from admin.xem_madv)
and T.comat = 1
and T.coquyendibau = 1;
/
CREATE USER nhanvien7 IDENTIFIED BY abc123;
GRANT CREATE SESSION TO nhanvien7;
GRANT TOLAPDANHSACH TO nhanvien7;
-------------

--%%%%%%%%%%%%%%%%%%%%%%%% MA HOA MA HOA MA HOA -%%%%%%%%%%%%%%%
alter session set "_ORACLE_SCRIPT"=true; 
set echo on
set serveroutput on

-- VAO SYSDBA CAP QUYEN TRUY CAP DBMS_CRYPYTO CHO ADMIN
grant execute on dbms_crypto to admin;
 
DECLARE
    key_bytes_raw RAW(32);
    key_char NVARCHAR2(64);
BEGIN
    key_bytes_raw := DBMS_CRYPTO.RANDOMBYTES(32);
    key_char := UTL_I18N.RAW_TO_CHAR(UTL_ENCODE.BASE64_ENCODE(key_bytes_raw), 'AL32UTF8');
    DBMS_OUTPUT.PUT_LINE('Key: ' || key_char);
END;
/

--Key: aVOQ35o4z7lCLqZ/s0RG06vwqosi2DJ5JPLrumpdqTo='
-- function ma hoa: 

--Key to be used for encryption: 52AB32; ^ $! ER94988OPS3W21
--Initialization vector (IV) to be used for encryption: TY54ABCX


-- store 'iv' voi 'key' vao table, chuyen sang dang hex
--drop table ALGPARAMETERS
CREATE TABLE ALGPARAMETERS
(
  NAME   VARCHAR2(100 BYTE),
  VALUE  NVARCHAR2(100)
);

INSERT INTO ALGPARAMETERS
   SELECT 'key' NAME,
          RAWTOHEX ('52AB32;^$!ER94988OPS3W21') VALUE
     FROM DUAL
   UNION
   SELECT 'iv' NAME, RAWTOHEX ('TY54ABCX') VALUE FROM DUAL;
COMMIT;

-- xem lai key vs iv vua tao trong ALGPARAMETERS;
SELECT * FROM ALGPARAMETERS;


--tao function encrypt voi input/ouput varchar2
CREATE OR REPLACE FUNCTION F_ENCRYPT (p_input VARCHAR2)
   RETURN VARCHAR2
AS
   v_encrypted_raw     RAW (2000);
   v_key               RAW (320);
   v_encryption_type   PLS_INTEGER
      :=   DBMS_CRYPTO.DES_CBC_PKCS5;
   v_iv                RAW (320);
BEGIN
   SELECT VALUE
     INTO v_key
     FROM algparameters
    WHERE name = 'key';
   SELECT VALUE
     INTO v_iv
     FROM algparameters
    WHERE name = 'iv';
   v_encrypted_raw :=
      DBMS_CRYPTO.encrypt (src   => UTL_I18N.STRING_TO_RAW (p_input, 'AL32UTF8'),
                           typ   => v_encryption_type,
                           key   => v_key,
                           iv    => v_iv);
   RETURN UTL_RAW.CAST_TO_VARCHAR2 (UTL_ENCODE.base64_encode (v_encrypted_raw));
END;

-- tao function decrypt voi in/out varchar2
CREATE OR REPLACE FUNCTION F_DECRYPT (p_input VARCHAR2)
   RETURN VARCHAR2
AS
   v_decrypted_raw     RAW (2000);
   v_key               RAW (320);
   v_encryption_type   PLS_INTEGER := DBMS_CRYPTO.DES_CBC_PKCS5;
   v_iv                RAW (320);
BEGIN
   SELECT VALUE
     INTO v_key
     FROM algparameters
    WHERE name = 'key';
   SELECT VALUE
     INTO v_iv
     FROM algparameters
    WHERE name = 'iv';
   v_decrypted_raw :=
      DBMS_CRYPTO.DECRYPT (
         src   => UTL_ENCODE.base64_decode (UTL_RAW.CAST_TO_RAW (p_input)),
         typ   => v_encryption_type,
         key   => v_key,
         iv    => v_iv);
   RETURN UTL_I18N.RAW_TO_CHAR (v_decrypted_raw, 'AL32UTF8');
END;

-- tao bang ketqua_ENC de luu du lieu ma hoa

--######### o day ta ma hoa nguoi di bau trong bang ket qua
drop table ketqua_mahoa
CREATE TABLE KETQUA_mahoa
(
    MANGUOIBAU varchar2 (50), 
    MAUCV INT, 
    NGAYBB DATE,
    CONSTRAINT KETQUAmahoa_PK PRIMARY KEY (MANGUOIBAU, MAUCV, NGAYBB)
); 
/
 

ALTER TABLE KETQUA_mahoa drop CONSTRAINT FK_KETQUAmh_UNGCUVIEN 
FOREIGN KEY (MAUCV) REFERENCES UNGCUVIEN(MATV);


--tao trigger de ma hoa cot diemtrungbinh trong bang sinh vien va cot diemthi trong bang dangky: 
-- xoa trigger neu ton tai 
drop trigger DTB_AFTER_TRIGGER

-- tao trigger ma hoa du lieu diem khi insert vao bang sinh vien
CREATE OR REPLACE TRIGGER NGUOIDIBAU_AFTER_TRIGGER
FOR INSERT ON KETQUA_MAHOA
COMPOUND TRIGGER
    row_id    rowid;
    AFTER EACH ROW IS
    BEGIN
      row_id := :new.rowid;
    END AFTER EACH ROW;
 
    AFTER STATEMENT IS
    BEGIN
      UPDATE KETQUA_MAHOA
      SET MANGUOIBAU = F_ENCRYPT(MANGUOIBAU)
      WHERE rowid = row_id;
    END AFTER STATEMENT;
END NGUOIDIBAU_AFTER_TRIGGER;
/
-- trigger de ma hoa du lieu diem thi sau khi dc insert


INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('1', 8, TO_DATE('10/6/2020','MM-DD-YYYY'));

INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('1', 5, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('1', 10, TO_DATE('10/7/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('2', 5, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('2', 13, TO_DATE('10/9/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('2', 15, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('4', 5, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('4', 10, TO_DATE('10/6/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('4', 13, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('7', 5, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('7', 8, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('7', 10, TO_DATE('10/7/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('9', 5, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('9', 8, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('9', 15, TO_DATE('10/6/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('12', 8, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('12', 10, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('12', 15, TO_DATE('10/5/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('14', 8, TO_DATE('10/7/2020','MM-DD-YYYY'));
INSERT INTO KETQUA_mahoa (MANGUOIBAU, MAUCV, NGAYBB) VALUES ('14', 10, TO_DATE('10/5/2020','MM-DD-YYYY'));


grant select on ketqua_mahoa to nhanvien7; 


conn nhanvien7/abc123
--select * from admin.ketqua_mahoa;
select F_decrypt(manguoibau), maucv, ngaybb from admin.ketqua_mahoa; 


---------VPD
CREATE OR REPLACE FUNCTION CUNGMADONVI (
p_schema IN VARCHAR2 DEFAULT NULL,
p_object IN VARCHAR2 DEFAULT NULL)
RETURN VARCHAR2
AS
dvuser int;
returnString varchar2(50);
BEGIN
if(USER='ADMIN') THEN
    NULL;
ELSe
select madv into dvuser from admin.thanhvien T 
where tendangnhap=lower(user);
returnString:=CONCAT('madv=',dvuser);
RETURN returnString;
END IF;
END;



BEGIN
DBMS_RLS.add_policy(object_schema => 'admin',
object_name => 'thanhvien',
policy_name => 'cung_don_vi',
---function_schema => 'admin',
policy_function => 'cungmadonvi',
statement_types => 'UPDATE',
update_check => TRUE);
END;


select * from thanhvien

-- matv = 10,11, dv = 4, null
-- matv = 8, dv = 2, null

alter session set "_ORACLE_SCRIPT"=true; 
CREATE USER nhanvien10 IDENTIFIED BY abc123;
GRANT CREATE SESSION TO nhanvien10;
GRANT TOlapdanhsach TO nhanvien10;

grant select,update on admin.thanhvien to nhanvien10;

conn nhanvien10/abc123;
update admin.thanhvien set nhiemvu=null where matv=11;


conn nhanvien10/abc123;
update admin.thanhvien set nhiemvu=null where matv=8;












